# Metadata Compatibility with Stable Diffusion Web UI

This document explains how DiffusionAPI implements metadata saving and reading in the same format as Stable Diffusion web UI, ensuring full compatibility between both applications.

## Overview

DiffusionAPI now saves generation metadata in images using the exact same format and methods as Stable Diffusion web UI. This means:

- **Images generated by DiffusionAPI** can be opened in Stable Diffusion web UI and all generation parameters will be automatically loaded
- **Images generated by Stable Diffusion web UI** can be processed by DiffusionAPI and all generation parameters will be automatically read
- **Both applications** can read and write metadata in PNG, JPEG, WebP, AVIF, and GIF formats

## How It Works

### Metadata Format

The metadata is stored as an "infotext" string that contains all generation parameters in a human-readable format:

```
a beautiful landscape with mountains and trees, masterpiece, best quality
Negative prompt: blurry, low quality, distorted
Steps: 30, Sampler: Euler a, Schedule type: Karras, CFG scale: 7.0, Seed: 123456789, Size: 512x512, Model: stable-diffusion-v1-5, Model hash: a1b2c3d4e5f6, VAE: vae-ft-mse-840000-ema-pruned, VAE hash: f6e5d4c3b2a1, Denoising strength: 0.75, Clip skip: 2, Face restoration: CodeFormer, User: test_user, Version: DiffusionAPI v1.0
```

### Storage Methods by Format

#### PNG Images
- Metadata is stored in PNG text chunks using the `parameters` key
- Uses `PngImagePlugin.PngInfo()` for embedding
- Most reliable method, preserves all data exactly

#### JPEG/WebP Images
- Metadata is stored in EXIF data using the `UserComment` field
- Uses `piexif` library for EXIF manipulation
- Automatically converts RGBA to RGB if needed

#### AVIF Images
- Metadata is stored in EXIF data similar to JPEG
- Uses the same `piexif` approach

#### GIF Images
- Metadata is stored in the GIF comment field
- Simple text storage method

## Implementation Details

### Key Functions

#### `create_infotext()`
Creates the metadata string in the exact format used by Stable Diffusion web UI:

```python
from diffusionapi.metadata import create_infotext

geninfo = create_infotext(
    prompt="a beautiful landscape",
    negative_prompt="blurry, low quality",
    steps=30,
    sampler_name="Euler a",
    scheduler="Karras",
    cfg_scale=7.0,
    seed=123456789,
    width=512,
    height=512,
    model_name="stable-diffusion-v1-5",
    # ... other parameters
)
```

#### `save_image_with_metadata()`
Saves an image with embedded metadata:

```python
from diffusionapi.metadata import save_image_with_metadata

save_image_with_metadata(
    image=pil_image,
    filename="output.png",
    geninfo=geninfo,
    extension=".png",
    jpeg_quality=85
)
```

#### `read_metadata_from_image()`
Reads metadata from an image:

```python
from diffusionapi.metadata import read_metadata_from_image

with Image.open("image.png") as img:
    geninfo, other_metadata = read_metadata_from_image(img)
```

#### `parse_infotext()`
Parses the infotext string back into a dictionary:

```python
from diffusionapi.metadata import parse_infotext

params = parse_infotext(geninfo)
print(f"Prompt: {params['prompt']}")
print(f"Seed: {params['Seed']}")
print(f"Steps: {params['Steps']}")
```

## Integration with DiffusionAPI

The metadata functionality is automatically integrated into the image generation pipeline:

1. **During Generation**: All generation parameters are collected
2. **Before Saving**: The `create_infotext()` function creates the metadata string
3. **During Saving**: The `save_image_with_metadata()` function embeds the metadata
4. **After Saving**: The metadata is also included in the progress file for API access

### Example Generated Metadata

When you generate an image with DiffusionAPI, it will include metadata like this:

```
a beautiful anime girl with blue hair, masterpiece, best quality, ultra detailed
Negative prompt: blurry, low quality, distorted, bad anatomy
Steps: 30, Sampler: Euler a, Schedule type: Karras, CFG scale: 7.0, Seed: 123456789, Size: 512x512, Model: stable-diffusion-v1-5, Model hash: a1b2c3d4e5f6, VAE: vae-ft-mse-840000-ema-pruned, VAE hash: f6e5d4c3b2a1, Denoising strength: 0.75, Clip skip: 2, Face restoration: CodeFormer, LoRAs: anime_style:0.8, detail_enhancer:0.6, Memory before: 2048.5 MB, Memory after: 3072.1 MB, Generation time: 12.34s, User: test_user, Version: DiffusionAPI v1.0
```

## Testing Compatibility

You can test the metadata functionality using the provided test script:

```bash
python test_metadata.py
```

This will:
1. Create test images with metadata in PNG, JPEG, and WebP formats
2. Read back the metadata to verify it was saved correctly
3. Parse the metadata to show the extracted parameters
4. Test compatibility with Stable Diffusion web UI format

## Verification in Stable Diffusion Web UI

To verify compatibility:

1. Generate an image with DiffusionAPI
2. Open the generated image in Stable Diffusion web UI
3. The generation parameters should automatically populate in the UI
4. You can then regenerate the image with the same parameters

## Supported Parameters

The metadata includes all standard Stable Diffusion parameters:

- **Basic**: prompt, negative_prompt, steps, cfg_scale, seed
- **Image**: width, height, size
- **Model**: model_name, model_hash, vae_name, vae_hash
- **Sampling**: sampler_name, scheduler
- **Advanced**: denoising_strength, clip_skip, tiling, restore_faces
- **Custom**: LoRAs, memory usage, generation time, user, version

## Dependencies

The metadata functionality requires the `piexif` library for EXIF handling:

```bash
pip install piexif==1.1.3
```

This is already included in the `requirements.in` file and will be installed automatically.

## Benefits

1. **Full Compatibility**: Images work seamlessly between both applications
2. **Parameter Preservation**: All generation settings are preserved exactly
3. **Multiple Formats**: Works with PNG, JPEG, WebP, AVIF, and GIF
4. **Human Readable**: Metadata is stored in a readable text format
5. **Extensible**: Easy to add new parameters or custom metadata

## Troubleshooting

### Metadata Not Reading
- Ensure the image format supports metadata (PNG is most reliable)
- Check that the `piexif` library is installed
- Verify the image wasn't modified by other software that strips metadata

### Format Issues
- PNG: Most reliable, preserves all data
- JPEG/WebP: May lose some data if processed by other software
- GIF: Limited to text comments only

### Compatibility Issues
- Both applications use the same metadata format
- If issues persist, check the exact infotext format in Stable Diffusion web UI
- Compare with the format generated by DiffusionAPI 